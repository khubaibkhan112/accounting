# Deployment Guide

## Prerequisites

- PHP 8.2 or higher
- Composer
- Node.js and npm
- MySQL 8.0 or higher
- Web server (Apache/Nginx)

## Step 1: Configure Environment Variables

1. Copy `.env.example` to `.env`:
```bash
cp .env.example .env
```

2. Generate application key:
```bash
php artisan key:generate
```

3. Update `.env` file with your configuration:

```env
APP_NAME="Accounting Software"
APP_ENV=production
APP_KEY=base64:... (generated by key:generate)
APP_DEBUG=false
APP_URL=http://your-domain.com

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=accounting_db
DB_USERNAME=your_db_user
DB_PASSWORD=your_db_password

CACHE_STORE=database
SESSION_DRIVER=database

MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="noreply@example.com"
MAIL_FROM_NAME="${APP_NAME}"
```

## Step 2: Run Migrations

1. Create the database:
```sql
CREATE DATABASE accounting_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. Run migrations:
```bash
php artisan migrate
```

This will create all necessary tables:
- users
- accounts
- transactions
- journal_entries
- journal_entry_items
- customers
- employees
- vehicles
- password_reset_tokens
- sessions
- cache (for database cache)

## Step 3: Seed Initial Data

Run the database seeder to create default users and accounts:

```bash
php artisan db:seed
```

This creates:
- Admin user: `admin@example.com` / `password`
- Accountant user: `accountant@example.com` / `password`
- Driver user: `driver@example.com` / `password`
- Default chart of accounts

**Important:** Change default passwords after first login!

## Step 4: Build Frontend Assets

1. Install npm dependencies:
```bash
npm install
```

2. Build production assets:
```bash
npm run build
```

This compiles Vue.js components and Tailwind CSS for production.

## Step 5: Configure Web Server

### Apache Configuration

Create or update your virtual host:

```apache
<VirtualHost *:80>
    ServerName your-domain.com
    DocumentRoot /path/to/accounting-software/public

    <Directory /path/to/accounting-software/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/accounting-error.log
    CustomLog ${APACHE_LOG_DIR}/accounting-access.log combined
</VirtualHost>
```

Enable mod_rewrite:
```bash
sudo a2enmod rewrite
sudo systemctl restart apache2
```

### Nginx Configuration

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/accounting-software/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

## Step 6: Set Permissions

Set proper permissions:

```bash
chown -R www-data:www-data /path/to/accounting-software
chmod -R 755 /path/to/accounting-software
chmod -R 775 /path/to/accounting-software/storage
chmod -R 775 /path/to/accounting-software/bootstrap/cache
```

## Step 7: Optimize Application

1. Cache configuration:
```bash
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

2. Optimize autoloader:
```bash
composer install --optimize-autoloader --no-dev
```

## Step 8: Set Up SSL (Recommended)

Use Let's Encrypt for free SSL certificates:

```bash
sudo certbot --apache -d your-domain.com
# or for Nginx:
sudo certbot --nginx -d your-domain.com
```

## Step 9: Set Up Scheduled Tasks

Add Laravel scheduler to cron:

```bash
crontab -e
```

Add:
```
* * * * * cd /path/to/accounting-software && php artisan schedule:run >> /dev/null 2>&1
```

## Step 10: Set Up Backups

### Database Backup Script

Create `/path/to/backup-script.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/path/to/backups"
DB_NAME="accounting_db"
DB_USER="your_db_user"
DB_PASS="your_db_password"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# Keep only last 30 days
find $BACKUP_DIR -name "backup_*.sql" -mtime +30 -delete
```

Make executable:
```bash
chmod +x /path/to/backup-script.sh
```

Add to cron (daily at 2 AM):
```
0 2 * * * /path/to/backup-script.sh
```

## Post-Deployment Checklist

- [ ] Change default user passwords
- [ ] Verify all migrations ran successfully
- [ ] Test login functionality
- [ ] Verify file permissions
- [ ] Test report generation
- [ ] Verify export functionality
- [ ] Set up monitoring/logging
- [ ] Configure email settings for password reset
- [ ] Set up regular backups
- [ ] Review security settings

## Troubleshooting

### 500 Error
- Check file permissions
- Check `.env` configuration
- Check Laravel logs: `storage/logs/laravel.log`
- Verify `APP_DEBUG=false` in production

### Database Connection Error
- Verify database credentials in `.env`
- Check database server is running
- Verify database exists

### Assets Not Loading
- Run `npm run build`
- Clear browser cache
- Check file permissions on `public/` directory

### Session Issues
- Verify `SESSION_DRIVER` in `.env`
- Check `storage/framework/sessions` permissions
- Clear session cache: `php artisan cache:clear`

## Maintenance

### Clear Caches
```bash
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

### Update Application
```bash
git pull origin main
composer install --no-dev --optimize-autoloader
php artisan migrate
npm install
npm run build
php artisan config:cache
php artisan route:cache
php artisan view:cache
```
